image: docker:latest
services:
- docker:dind

stages:
- test
- build
- production

before_script:
- apk update && apk upgrade
- apk add --update bash curl git gettext openssh python python-dev py-pip build-base openssl wget
- pip install docker-compose

- docker login -u gitlab-ci-token -p $CI_JOB_TOKEN registry.gitlab.com
- docker network create bicing-api-network

- ENVIRONMENT=$(echo $CI_BUILD_REF_NAME | awk -F'/' '{print $1}')
- PRODUCTION_TAG=$(echo $CI_BUILD_REF_NAME | awk -F'/' '{print $2}')
- export PRODUCTION_IMAGE="$CI_REGISTRY_IMAGE:$PRODUCTION_TAG"

.qa:
  script:
  - cp .env.dist .env
  - docker-compose up -d
  - docker-compose exec php composer install
  - docker-compose exec php bin/phpstan analyse src --level max
  - docker-compose exec php bin/phpcs --standard=PSR2 src
  - docker-compose exec php bin/phpspec run
  - docker-compose exec php bin/console do:mi:mi -n --env=test
  - docker-compose exec php bin/simple-phpunit
  - docker-compose exec php bin/behat
  - docker-compose exec php rm -rf var/cache/* var/log/*
  - docker-compose down -v --remove-orphans

test:
  environment: test
  extends: .qa
  script:
  - echo "Hello We will now be preparing the test environment for you."
  stage: test
  only:
  - /^[F|f]eature\/.*$/

build:
  environment: build
  extends: .qa
  script:
  - echo "Hello We will now be preparing the build environment for you."
  - docker build --target bicing_api_php -t $PRODUCTION_IMAGE .
  - docker push $PRODUCTION_IMAGE
  stage: build
  only:
  - /^[R|r]elease\/.*$/
  - /^[H|h]otfix\/.*$/

### Production Environment
production:
  environment: production
  stage: production
  script:
  - echo "Hello We will now be preparing the production environment for you."
  - chmod +x ./docker/stages/production/deploy.sh
  - ./docker/stages/production/deploy.sh
  when: manual
  only:
  - /^[R|r]elease\/.*$/
  - /^[H|h]otfix\/.*$/

